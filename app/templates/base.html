<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>{% block title %}Invent√°rio{% endblock %}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">

  <!-- ‚úÖ Topbar + bot√µes ainda menores -->
  <style>
    /* ===== TOPBAR (header) ===== */
    .topbar{
      position: sticky;
      top: 0;
      z-index: 50;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      background: rgba(15, 15, 18, .60);
      border-bottom: 1px solid rgba(255,255,255,.08);
    }

    /* üîΩ Barra superior ainda mais baixa */
    .topbar .topbar-inner{
      padding: 4px 0;
    }

    /* Logo menor */
    .brand-icon{
      border-radius: 14px;
      padding: 4px 7px;
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02));
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }

    /* ===== Bot√µes do TOPO ainda menores ===== */
    .topbar .btn{
      padding: 5px 9px !important;
      font-size: .82rem !important;
      border-radius: 10px !important;
      line-height: 1 !important;
      min-height: 30px;
      display: inline-flex;
      align-items: center;
      gap: 7px;
      letter-spacing: .2px;
      box-shadow: 0 10px 24px rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.10);
    }

    .topbar .btn:hover{
      transform: translateY(-1px);
      filter: brightness(1.02);
    }
    .topbar .btn:active{
      transform: translateY(0px);
    }

    .nav{
      gap: 6px !important;
    }

    /* Responsivo */
    @media (max-width: 900px){
      .topbar .topbar-inner{
        gap: 10px !important;
        padding: 4px 0;
      }

      .brand-icon{
        width: 64px !important;
        height: 44px !important;
      }
      .brand-icon img{
        height: 44px !important;
      }

      .topbar .btn{
        padding: 5px 8px !important;
        font-size: .80rem !important;
        border-radius: 10px !important;
        min-height: 29px;
      }
    }

    /* ===== Conte√∫do ===== */
    .main{
      padding-top: 14px;
    }

    /* ===== Modais: leve upgrade visual ===== */
    .modal.card{
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(22,22,26,.92);
      box-shadow: 0 24px 80px rgba(0,0,0,.55);
      border-radius: 18px;
    }

    .modal-header{
      border-bottom: 1px solid rgba(255,255,255,.08);
      padding-bottom: 10px;
    }

    .modal-backdrop.show{
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(3px);
      -webkit-backdrop-filter: blur(3px);
    }

    .modal .input{
      border-radius: 12px;
    }
  </style>
</head>

<body class="app">

  <header class="topbar">
    <div class="container topbar-inner" style="
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    ">

      <!-- ESQUERDA: LOGO -->
      <a href="{{ url_for('main.index') }}" class="brand" style="
        display:flex;
        align-items:center;
        gap:10px;
        text-decoration:none;
        flex:0 0 auto;
      ">
        <div class="brand-icon" style="
          width:68px;
          height:46px;
          display:flex;
          align-items:center;
          justify-content:center;
          overflow:hidden;
        ">
          <img
            src="{{ url_for('static', filename='logo.png') }}"
            alt="Logo"
            style="
              height:46px;
              width:auto;
              max-width:100%;
              object-fit:contain;
            "
          >
        </div>

        <div class="brand-text" style="display:none;">
          <div class="brand-title">Invent√°rio</div>
          <div class="muted small">IMO</div>
        </div>
      </a>

      <!-- CENTRO: BOT√ïES -->
      <nav class="nav" style="
        flex:1 1 auto;
        display:flex;
        align-items:center;
        justify-content:center;
        flex-wrap:wrap;
        min-width:0;
      ">
        <a class="btn btn-orange" href="{{ url_for('main.index') }}">Invent√°rio</a>
        <a class="btn btn-orange" href="{{ url_for('main.locations_sectors') }}">Cadastro de Localiza√ß√£o</a>
        <a class="btn btn-orange" href="{{ url_for('main.equipments_list') }}">Equipamentos</a>
        <a class="btn btn-orange" href="{{ url_for('main.almoxarifado') }}">Almoxarifado</a>

        <button class="btn btn-orange" type="button" onclick="openScanModal()">
          Pesquisa (C√¢mera)
        </button>
      </nav>

      <!-- DIREITA: SAIR -->
      <div style="flex:0 0 auto; display:flex; align-items:center;">
        <a class="btn btn-danger" href="{{ url_for('auth.logout') }}">Sair</a>
      </div>

    </div>
  </header>

  <main class="main">
    <div class="container page">
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          <div class="flash-wrap">
            {% for category, message in messages %}
              <div class="flash {{ category }}">{{ message }}</div>
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}

      {% block content %}{% endblock %}
    </div>
  </main>

  {% block modal %}{% endblock %}

  <!-- ===================== MODAL SCAN (C√ÇMERA) ===================== -->
  <div class="modal-backdrop" id="scanModal" aria-hidden="true">
    <!-- ‚úÖ diminu√≠do: modal-md (igual ao outro) -->
    <div class="modal card modal-md" role="dialog" aria-modal="true" aria-labelledby="scanTitle">
      <div class="modal-header">
        <div>
          <div id="scanTitle" style="font-weight:900;">Pesquisar por c√¢mera</div>
          <div class="muted small">Aponte para o QR Code / C√≥digo de barras</div>
        </div>
        <button class="btn" type="button" onclick="closeScanModal()">Fechar</button>
      </div>

      <div class="modal-body">
        <div class="card" style="padding:12px;">
          <!-- ‚úÖ limita altura do leitor para n√£o ‚Äúestourar‚Äù -->
          <div id="qr-reader" style="width:100%;max-height:60vh;overflow:hidden;border-radius:12px;"></div>
          <div id="scanHint" class="muted small" style="margin-top:10px;">
            Se n√£o aparecer a c√¢mera, autorize nas permiss√µes do navegador.
          </div>
        </div>

        <form class="form-grid" onsubmit="manualSearch(event)" style="margin-top:12px;">
          <div class="field col-9">
            <label>Pesquisar manualmente</label>
            <input class="input" id="scanManual" placeholder="Digite o c√≥digo..." autocomplete="off">
          </div>
          <div class="field col-3 actions" style="display:flex;align-items:end;">
            <button class="btn btn-orange" type="submit" style="width:100%;">Buscar</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- ===================== MODAL PRODUTO (DETALHES) ===================== -->
  <div class="modal-backdrop" id="productModal" aria-hidden="true">
    <div class="modal card modal-md" role="dialog" aria-modal="true" aria-labelledby="productTitle">
      <div class="modal-header">
        <div>
          <div id="productTitle" style="font-weight:900;">Produto</div>
          <div class="muted small" id="productSubtitle">Detalhes do equipamento</div>
        </div>
        <button class="btn" type="button" onclick="closeProductModal()">Fechar</button>
      </div>

      <div class="modal-body">
        <div class="card" style="padding:14px; display:grid; gap:10px;">
          <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <span class="badge" id="pm_code">PAT/C√≥digo: -</span>
            <span class="badge" id="pm_sector">Setor: -</span>
            <span class="badge" id="pm_location">Local: -</span>
          </div>

          <div style="display:grid; gap:6px;">
            <div style="font-weight:900; font-size:1.05rem;" id="pm_name">Nome: -</div>
            <div class="muted small" id="pm_brand">Marca: -</div>
            <div class="muted small" id="pm_nf">NF: -</div>
            <div class="muted small" id="pm_value">Valor: -</div>
          </div>
        </div>

        <div class="modal-actions" style="margin-top:12px;">
          <a class="btn" id="pm_open" href="{{ url_for('main.equipments_list') }}">Abrir na lista</a>
          <button class="btn btn-orange" type="button" onclick="scanAgain()">Escanear outro</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/html5-qrcode" defer></script>

  <script>
    let html5QrCode = null;
    let scannerRunning = false;

    function openScanModal(){
      const modal = document.getElementById('scanModal');
      modal.classList.add('show');
      modal.setAttribute('aria-hidden', 'false');

      const waitLib = () => {
        if (!window.Html5Qrcode) return setTimeout(waitLib, 80);
        startScanner();
      };
      waitLib();
    }

    async function startScanner(){
      if (scannerRunning) return;

      const el = document.getElementById("qr-reader");
      if (!el) return;

      el.innerHTML = "";
      html5QrCode = new Html5Qrcode("qr-reader");

      try{
        scannerRunning = true;

        await html5QrCode.start(
          { facingMode: "environment" },
          {
            fps: 12,
            qrbox: { width: 220, height: 220 }, // ‚úÖ menor
            aspectRatio: 1.7777778,
            disableFlip: true
          },
          (decodedText) => handleScanResult(decodedText),
          () => {}
        );
      }catch(err){
        scannerRunning = false;
        document.getElementById("qr-reader").innerHTML =
          `<div class="muted small">N√£o foi poss√≠vel abrir a c√¢mera. Verifique permiss√µes do navegador e tente novamente.</div>`;
      }
    }

    async function stopScanner(){
      if (!html5QrCode || !scannerRunning) return;
      try{
        await html5QrCode.stop();
        await html5QrCode.clear();
      }catch(e){}
      scannerRunning = false;
      html5QrCode = null;
    }

    async function closeScanModal(){
      await stopScanner();
      const modal = document.getElementById('scanModal');
      modal.classList.remove('show');
      modal.setAttribute('aria-hidden', 'true');
    }

    function openProductModal(){
      const modal = document.getElementById('productModal');
      modal.classList.add('show');
      modal.setAttribute('aria-hidden', 'false');
    }

    async function closeProductModal(){
      const modal = document.getElementById('productModal');
      modal.classList.remove('show');
      modal.setAttribute('aria-hidden', 'true');
    }

    document.addEventListener("click", async (e) => {
      const scan = document.getElementById("scanModal");
      const prod = document.getElementById("productModal");

      if (scan.classList.contains("show") && e.target === scan) await closeScanModal();
      if (prod.classList.contains("show") && e.target === prod) await closeProductModal();
    });

    document.addEventListener("keydown", async (e) => {
      if (e.key !== "Escape") return;
      const scan = document.getElementById("scanModal");
      const prod = document.getElementById("productModal");

      if (scan.classList.contains("show")) await closeScanModal();
      if (prod.classList.contains("show")) await closeProductModal();
    });

    function manualSearch(e){
      e.preventDefault();
      const v = document.getElementById("scanManual").value.trim();
      if (!v) return;
      handleScanResult(v);
    }

    function formatBRL(valueStr){
      if (!valueStr) return "-";
      const n = Number(String(valueStr).replace(",", "."));
      if (Number.isNaN(n)) return valueStr;
      try{
        return n.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
      }catch(e){
        return valueStr;
      }
    }

    async function handleScanResult(text){
      await stopScanner();

      try{
        const res = await fetch(`/api/equipment/by-barcode?code=${encodeURIComponent(text)}`, {
          headers: { "Accept": "application/json" }
        });
        const data = await res.json();

        document.getElementById('scanModal').classList.remove('show');
        document.getElementById('scanModal').setAttribute('aria-hidden', 'true');

        if (!data.ok){
          fillProductNotFound(text, true);
          openProductModal();
          return;
        }

        if (!data.found){
          fillProductNotFound(text, false);
          openProductModal();
          return;
        }

        const eq = data.equipment || {};

        document.getElementById("productTitle").textContent = "Equipamento encontrado";
        document.getElementById("productSubtitle").textContent = "Informa√ß√µes do cadastro";

        document.getElementById("pm_code").textContent = `PAT/C√≥digo: ${eq.barcode_pat || "-"}`;
        document.getElementById("pm_sector").textContent = `Setor: ${eq.sector || "-"}`;
        document.getElementById("pm_location").textContent = `Local: ${eq.location || "-"}`;

        document.getElementById("pm_name").textContent = eq.name ? eq.name : "Nome: -";
        document.getElementById("pm_brand").textContent = `Marca: ${eq.brand || "-"}`;
        document.getElementById("pm_nf").textContent = `NF: ${eq.invoice_nf || "-"}`;
        document.getElementById("pm_value").textContent = `Valor: ${formatBRL(eq.value)}`;

        const url = new URL("{{ url_for('main.equipments_list') }}", window.location.origin);
        url.searchParams.set("q", eq.barcode_pat || text);
        document.getElementById("pm_open").href = url.toString();

        openProductModal();

      }catch(err){
        document.getElementById('scanModal').classList.remove('show');
        document.getElementById('scanModal').setAttribute('aria-hidden', 'true');
        fillProductNotFound(text, true);
        openProductModal();
      }
    }

    function fillProductNotFound(code, isError){
      document.getElementById("productTitle").textContent = isError ? "Erro ao consultar" : "N√£o encontrado";
      document.getElementById("productSubtitle").textContent = isError
        ? "Falha ao consultar o cadastro"
        : "Nenhum equipamento cadastrado com esse PAT/C√≥digo";

      document.getElementById("pm_code").textContent = `PAT/C√≥digo: ${code}`;
      document.getElementById("pm_sector").textContent = `Setor: -`;
      document.getElementById("pm_location").textContent = `Local: -`;

      document.getElementById("pm_name").textContent = isError ? "Tente novamente." : "Voc√™ pode cadastrar este item.";
      document.getElementById("pm_brand").textContent = "Marca: -";
      document.getElementById("pm_nf").textContent = "NF: -";
      document.getElementById("pm_value").textContent = "Valor: -";

      const url = new URL("{{ url_for('main.equipments_list') }}", window.location.origin);
      url.searchParams.set("q", code);
      document.getElementById("pm_open").href = url.toString();
    }

    async function scanAgain(){
      await closeProductModal();
      openScanModal();
    }
  </script>

</body>
</html>
